{
  "hash": "2f6066960c2d5b19e251e730624442c0",
  "result": {
    "markdown": "---\ntitle: \"Ungulate Seasonal Ranges\"\n---\n\nI am currently an Associate Research Scientist for the Wyoming Cooperative Fish and Wildlife Research Unit modeling ungulate seasonal ranges and migrations for Idaho Department of Fish and Game in support of [S.O. 3362](https://www.doi.gov/sites/doi.gov/files/uploads/so_3362_migration.pdf). So far, I've completed winter range models for mule deer using the random forest machine learning algorithm in a resource selection function framework. I assembled these predictions into a dashboard to assist in assessing the predictions and outputs. Included in the dashboard are maps depicting the average predicted winter range for mule deer in each of IDFG's mule deer data analysis units (DAUs). In addition, I've started to analyze the changes in winter range predictions across years.\n\n## {{< fa chart-line >}} Seasonal Range Analysis Dashboard\n![](_images/animation_dashboard.gif)\n\n### {{< fa map >}} Average Winter Range Map\n![](_images/SmokeyBoiseMuleDeer_AverageWinterRange.png){height=670 width=800}\n\n### {{< fa snowflake >}} Annual Winter Ranges\n![](_images/Smokey-Boise_animation.gif)\n\n\n## {{< fa layer-group >}} Vegetation Classification Covariates\nA major component of the seasonal range models is IDFG's vegetation classification covariates which are derived from [LANDFIRE](https://landfire.gov/). The models explicitly require each vegetation class to be transformed to a focal value based on the average daily movement distance of individuals in the DAU. To streamline this covariate transformation, I wrote a Python function using ESRI's `arcpy` and Spatial Analyst tools, which are called by an R script I wrote to iterate the process over each collection of DAU covariates.\n\n### {{< fa scroll >}} Python Function\n\n\n::: {.cell}\n\n```{.python .cell-code}\n# --------------------------------------------------------\n# Calculate Hurley Vegetation Focal Statistics\n# Author: Robert Ritson, Associate Research Scientist (UW)\n# Last Updated: 5/10/2022\n# Description: Calculate square meters of Hurley\n#   vegetation classes (binary rasters derrived from LANDFIRE)\n#   given a mean daily movement distance (from an ungulate population),\n#   clipped by a population DAU boundary\n# --------------------------------------------------------\n#Import modules\nimport arcpy\nfrom arcpy.sa import *\nimport datetime\nimport csv\nimport os\narcpy.CheckOutExtension(\"Spatial\")\n#Define function\ndef hveg_focal(path_to_dau, mdm_ci95, path_to_hveg, dau_hveg_folder, scratch = \"C:\\\\Users\\\\rritson\\\\Documents\\\\ArcGIS\\\\scratch\\\\\"):\n    try:\n        print 'begin script on '+datetime.datetime.now().date().isoformat()+' at '+datetime.datetime.now().time().isoformat()[0:8]\n\n        # Set path to folders and workspace\n        dauws = path_to_dau\n        rastws = path_to_hveg\n        outws = dau_hveg_folder\n        neighborhood = arcpy.sa.NbrCircle(mdm_ci95,\"MAP\")\n        arcpy.env.overwriteOuptput = False\n        arcpy.env.workspace = scratch\n\n        # Buffer Selected DAU by provided mean daily movement\n        print 'buffering DAU shape by mean daily movement input (meters)'\n        arcpy.Buffer_analysis(dauws,scratch+'\\\\DAU_Buffer.shp', mdm_ci95,\"FULL\",\"ROUND\",\"NONE\",\"\",\"PLANAR\")\n        \n        # List Hurley Vegetation Rasters\n        arcpy.env.workspace = rastws\n        try:\n            print 'listing Hveg rasters'\n            hveg_list = [hveg for hveg in arcpy.ListRasters()]\n        except:  print arcpy.GetMessages(2)\n\n        # Clip Hurley Vegetation Raster to buffered DAU and calculate focal statistics\n        arcpy.env.workspace = scratch\n        for hveg in hveg_list:\n            print 'loading raster '+hveg\n            arcpy.MakeRasterLayer_management(rastws+'/'+hveg,'temp_rast.tif',\"\",scratch+'/DAU_Buffer.shp',\"\") #load raster and clip to buffered DAU extent\n\n            print 'calculating focal statistics'\n            arcpy.CheckOutExtension(\"Spatial\")\n            fstat = FocalStatistics('temp_rast.tif',  neighborhood, \"SUM\", \"DATA\") #Focal sum of binaries by mean daily movement distance\n            \n            print 'converting to square meters'\n            outrast = fstat * (30^2) #multiply focal sum by cell dimensions (convert to square meters)\n            outrast.save(outws+hveg) #save output\n\n            print hveg+' raster saved to '+outws+' at '+datetime.datetime.now().time().isoformat()[0:8]\n\n        print 'Finished: Completed Hurley vegetation density rasters for '+dauws+' located in '+outws\n        print 'script completed on '+datetime.datetime.now().date().isoformat()+' at '+datetime.datetime.now().time().isoformat()[0:8]\n\n    except:  print arcpy.GetMessages(2)\narcpy.CheckInExtension(\"Spatial\")\n# # # # # END OF FUNCTION # # # # # # #\n```\n:::\n\n\n\n### {{< fa code >}} R code\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Hurley Vegetation Density Raster Calculations ##\n### Loop through remaining DAUs (~10min per DAU) ###\n#Load package\nrequire(dplyr)\n\n#devtools::install_github(\"rstudio/reticulate\")\n#Sys.setenv(RETICULATE_PYTHON = \"C:\\\\Python27\\\\ArcGIS10.8\\\\\\\\pythonw.exe\")\nSys.setenv(RETICULATE_PYTHON = 'C:/Users/rritson/AppData/Local/Programs/ArcGIS/Pro/bin/Python/envs/arcgispro-py3/python.exe')\nrequire(reticulate)\n\n\n#DAU List\ndau_list <- sf::st_read('C:/Users/rritson/Documents/Projects/MuleDeer_SeasonalRanges/DAU_BBox_10kbuff.shp') %>%\n  as.data.frame(.) %>%\n  dplyr::select(NAME) %>%\n  #dplyr::filter(NAME == \"Island Park\")\n  dplyr::filter(NAME %in% c(\"Bannock\",\"Caribou\",\"Mountain Valley\",\"Portneuf\",\"Weiser-McCall\"))\n  #dplyr::filter(!(NAME %in% c(\"Bitterroot\",\"Panhandle\",\"Lower Salmon\",\"Snake River\",\"Smokey-Boise\",\"Island Park\")))\n\n#DAU shape (all)\ndau_shp <- sf::st_read('C:/Users/rritson/Documents/Projects/MuleDeer_SeasonalRanges/DAU_BBox_10kbuff.shp') %>%\n  #dplyr::select(-GlobalID,-Shape_Leng,-Shape_Area) %>% \n  sfheaders::sf_remove_holes(.)\n\n#Movement Data\ndat <- readRDS(\"C:/Users/rritson/Documents/Projects/MuleDeer_SeasonalRanges/Winter_RSF/MD_Winter_Locs_1pd.rds\") %>% as.data.frame(.)\n\n# Check R Session Info\nif(sessionInfo()$R.version$arch != \"i386\"){\n  print(\"STOP: Must run R in 32-bit Architecture to source 'arcpy'\")\n  }\nif(paste0(sessionInfo()$R.version$major,\".\",sessionInfo()$R.version$minor) > \"4.0.4\"){\n  print(\"STOP: Must run R in version prior or equal to 4.0.4 to source 'arcpy'\") \n  # reticulate does not want to work with R version 4.1.0...\n  }\n\n# Initiate Python before beginning loop\n#reticulate::use_python(\"C:\\\\Python27\\\\ArcGIS10.8\\\\\\\\pythonw.exe\", required = T)\nreticulate::use_python('C:/Users/rritson/AppData/Local/Programs/ArcGIS/Pro/bin/Python/envs/arcgispro-py3/python.exe', required = T)\nreticulate::py_config()\nreticulate::source_python(\"C:/Users/rritson/Documents/Python Scripts/hveg_focal_func.py\")\n#reticulate::source_python(\"C:/Users/rritson/Documents/Python Scripts/hveg_focal_func_sing.py\") #for dealing with a single raster (must change file paths below if so)\n\n# Loop through DAUs\nfor (i in 1:nrow(dau_list)){\n  \n  # Select DAU\n  print(paste(\"Beginning DAU:\",dau_list[i,],\"(\",nrow(dau_list)-i,\"remaining)...\"))\n  dau_sel <- dau_list[i,] \n  \n  # Create folder for outputs\n  #print(\"Creating output folder...\")\n  #dir.create(\"F:/Seasonal_range_covars/mdmci95_2buff\") \n  #dir.create(paste0(\"F:/Seasonal_range_covars/mdmci95_2buff/\",dau_sel)) \n  \n  # Write DAU shapefile\n  #print(\"Writing shapefile...\")\n  #dau <- dau_shp %>% dplyr::filter(NAME == dau_sel)\n  #sf::write_sf(dau,paste0('C:/Users/rritson/Documents/Projects/MuleDeer_SeasonalRanges/SeasonalRanges/',dau_sel,\".shp\"),append=F)\n  \n  # Get Mean Daily Movements for DAU\n  print(\"Accessing mean daily movement (95% CI, in meters)...\")\n  mdm_ci95 <- dat %>% dplyr::filter(DAU == dau_sel) %>% dplyr::select(MDM_CI95_avg) %>% dplyr::slice(1)\n  mdm_ci95 <- mdm_ci95[[1]]\n  mdm_ci95_2 <- mdm_ci95 / 2\n  \n  # Calculate Hurley vegetation density raster for DAU: Mean Daily Movement\n  print(\"Reticulating HVeg Density Raster Calculation (Mean Daily Movement)...\")\n  hveg_focal(path_to_dau = paste0('C:/Users/rritson/Documents/Projects/MuleDeer_SeasonalRanges/SeasonalRanges/',dau_sel,\".shp\"),\n             mdm_ci95 = mdm_ci95, #mean daily movement\n             path_to_hveg = \"F:\\\\Seasonal_range_covars\\\\hveg\",\n             dau_hveg_folder = paste0(\"F:/Seasonal_range_covars/mdmci95_buff/\",dau_sel,\"/\"), #CHANGE THIS!!! (to match output folder)\n             scratch = \"C:/Users/rritson/Documents/ArcGIS/scratch\")\n  \n  #Delete temp files\n  lapply(list.files(\"C:/Users/rritson/Documents/ArcGIS/scratch\",full.names = T),file.remove)\n  gc()\n  \n  # Calculate Hurley vegetation density raster for DAU: One-half Mean Daily Movement\n  print(\"Reticulating HVeg Density Raster Calculation (One-Half Mean Daily Movement)...\")\n  hveg_focal(path_to_dau = paste0('C:/Users/rritson/Documents/Projects/MuleDeer_SeasonalRanges/SeasonalRanges/',dau_sel,\".shp\"),\n             mdm_ci95 = mdm_ci95_2, #one-half mean daily movement\n             path_to_hveg = \"F:\\\\Seasonal_range_covars\\\\hveg\",\n             dau_hveg_folder = paste0(\"F:/Seasonal_range_covars/mdmci95_2buff/\",dau_sel,\"/\"), #CHANGE THIS!!! (to match output folder)\n             scratch = \"C:/Users/rritson/Documents/ArcGIS/scratch\")\n  \n  #Delete temp files\n  lapply(list.files(\"C:/Users/rritson/Documents/ArcGIS/scratch\",full.names = T),file.remove)\n  gc()\n}\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}